import React, { useState, useEffect } from 'react';
import { Loader2 } from 'lucide-react';

const CreditCalculator = () => {
  const [loading, setLoading] = useState(true);
  const [amount, setAmount] = useState('');
  const [downPaymentPercent, setDownPaymentPercent] = useState('');
  const [term, setTerm] = useState('');
  const [gracePeriod, setGracePeriod] = useState('');
  const [yearlyRate, setYearlyRate] = useState('');
  const [payments, setPayments] = useState([]);
  const [yearlyTotals, setYearlyTotals] = useState([]);
  const [totalPayment, setTotalPayment] = useState(0);

  useEffect(() => {
    const timer = setTimeout(() => {
      setLoading(false);
    }, 2000);
    return () => clearTimeout(timer);
  }, []);

  const calculatePayments = () => {
    const downPaymentAmount = (Number(amount) * Number(downPaymentPercent)) / 100;
    const principal = Number(amount) - downPaymentAmount;
    const monthlyRate = (Number(yearlyRate) / 12) / 100;
    const totalMonths = Number(term) * 12;
    const graceMonths = Number(gracePeriod);

    let monthlyPayment = (principal * monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                        (Math.pow(1 + monthlyRate, totalMonths) - 1);

    let payments = [];
    let balance = principal;
    let yearTotal = 0;
    let yearlyTotals = [];
    let currentYear = 1;
    let yearCount = 0;

    for (let month = 1; month <= totalMonths + graceMonths; month++) {
      if (month <= graceMonths) {
        const interest = balance * monthlyRate;
        payments.push({
          month,
          payment: interest,
          interest,
          principal: 0,
          balance
        });
        yearTotal += interest;
      } else {
        const interest = balance * monthlyRate;
        const principalPart = monthlyPayment - interest;
        balance -= principalPart;

        payments.push({
          month,
          payment: monthlyPayment,
          interest,
          principal: principalPart,
          balance: Math.max(0, balance)
        });
        yearTotal += monthlyPayment;
      }

      yearCount++;
      if (yearCount === 12 || month === totalMonths + graceMonths) {
        yearlyTotals.push({
          year: currentYear,
          total: yearTotal
        });
        yearTotal = 0;
        yearCount = 0;
        currentYear++;
      }
    }

    setPayments(payments);
    setYearlyTotals(yearlyTotals);
    setTotalPayment(payments.reduce((sum, payment) => sum + payment.payment, 0));
  };

  const getSummary = () => {
    if (!amount || !downPaymentPercent) return null;
    const downPaymentAmount = (Number(amount) * Number(downPaymentPercent)) / 100;
    return {
      totalAmount: Number(amount),
      downPayment: downPaymentAmount,
      loanAmount: Number(amount) - downPaymentAmount
    };
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen w-full bg-gray-100">
        <div className="flex flex-col items-center gap-4">
          <Loader2 className="h-16 w-16 animate-spin text-blue-500" />
          <h2 className="text-2xl font-bold text-gray-700">LOADING...</h2>
        </div>
      </div>
    );
  }

  const summary = getSummary();

  return (
    <div className="p-4 max-w-4xl mx-auto">
      <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 className="text-2xl font-bold mb-6 text-center">Kredit Kalkulyatori</h1>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div className="space-y-2">
            <label className="block text-sm font-medium">Kredit miqdori:</label>
            <input
              type="number"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="w-full p-2 border rounded"
              placeholder="Summa kiriting"
            />
          </div>
          
          <div className="space-y-2">
            <label className="block text-sm font-medium">Boshlang'ich to'lov (%):</label>
            <input
              type="number"
              value={downPaymentPercent}
              onChange={(e) => setDownPaymentPercent(e.target.value)}
              className="w-full p-2 border rounded"
              placeholder="Foizni kiriting"
              min="0"
              max="100"
            />
          </div>
          
          <div className="space-y-2">
            <label className="block text-sm font-medium">Muddat (yil):</label>
            <input
              type="number"
              value={term}
              onChange={(e) => setTerm(e.target.value)}
              className="w-full p-2 border rounded"
              placeholder="Yilni kiriting"
            />
          </div>
          
          <div className="space-y-2">
            <label className="block text-sm font-medium">Imtiyoz davri (oy):</label>
            <input
              type="number"
              value={gracePeriod}
              onChange={(e) => setGracePeriod(e.target.value)}
              className="w-full p-2 border rounded"
              placeholder="Oyni kiriting"
            />
          </div>
          
          <div className="space-y-2">
            <label className="block text-sm font-medium">Yillik foiz stavkasi (%):</label>
            <input
              type="number"
              value={yearlyRate}
              onChange={(e) => setYearlyRate(e.target.value)}
              className="w-full p-2 border rounded"
              placeholder="Foizni kiriting"
            />
          </div>
        </div>

        {summary && (
          <div className="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 className="font-medium mb-2">Kredit ma'lumotlari:</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div>
                <span className="text-gray-600">Umumiy summa:</span>
                <div className="font-medium">{summary.totalAmount.toLocaleString('uz-UZ')} so'm</div>
              </div>
              <div>
                <span className="text-gray-600">Boshlang'ich to'lov:</span>
                <div className="font-medium">{summary.downPayment.toLocaleString('uz-UZ')} so'm</div>
              </div>
              <div>
                <span className="text-gray-600">Kredit summasi:</span>
                <div className="font-medium">{summary.loanAmount.toLocaleString('uz-UZ')} so'm</div>
              </div>
            </div>
          </div>
        )}
        
        <button
          onClick={calculatePayments}
          className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
        >
          Hisoblash
        </button>
      </div>

      {payments.length > 0 && (
        <div className="bg-white rounded-lg shadow-lg p-6">
          <h2 className="text-xl font-bold mb-4">To'lovlar jadvali</h2>
          <div className="overflow-x-auto">
            <table className="min-w-full">
              <thead>
                <tr className="bg-gray-100">
                  <th className="p-2 border">Oy</th>
                  <th className="p-2 border">To'lov</th>
                  <th className="p-2 border">Foiz</th>
                  <th className="p-2 border">Asosiy qarz</th>
                  <th className="p-2 border">Qoldiq</th>
                </tr>
              </thead>
              <tbody>
                {payments.map((payment) => (
                  <tr key={payment.month}>
                    <td className="p-2 border text-center">{payment.month}</td>
                    <td className="p-2 border text-right">{payment.payment.toLocaleString('uz-UZ', { maximumFractionDigits: 2 })}</td>
                    <td className="p-2 border text-right">{payment.interest.toLocaleString('uz-UZ', { maximumFractionDigits: 2 })}</td>
                    <td className="p-2 border text-right">{payment.principal.toLocaleString('uz-UZ', { maximumFractionDigits: 2 })}</td>
                    <td className="p-2 border text-right">{payment.balance.toLocaleString('uz-UZ', { maximumFractionDigits: 2 })}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <h2 className="text-xl font-bold mt-6 mb-4">Yillik to'lovlar</h2>
          <div className="overflow-x-auto">
            <table className="min-w-full">
              <thead>
                <tr className="bg-gray-100">
                  <th className="p-2 border">Yil</th>
                  <th className="p-2 border">Jami to'lov</th>
                </tr>
              </thead>
              <tbody>
                {yearlyTotals.map((yearData) => (
                  <tr key={yearData.year}>
                    <td className="p-2 border text-center">{yearData.year}</td>
                    <td className="p-2 border text-right">{yearData.total.toLocaleString('uz-UZ', { maximumFractionDigits: 2 })}</td>
                  </tr>
                ))}
                <tr className="font-bold bg-gray-50">
                  <td className="p-2 border">JAMI:</td>
                  <td className="p-2 border text-right">{totalPayment.toLocaleString('uz-UZ', { maximumFractionDigits: 2 })}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );
};

export default CreditCalculator;
